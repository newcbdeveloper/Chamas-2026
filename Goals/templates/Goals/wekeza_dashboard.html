{% extends 'goal_base.html' %}
{% load static %}

{% block title %}
<title>Wekeza Goals - ChamaSpace</title>
{% endblock %}

{% block content %}
<div class="wrapper modern-dashboard">
    <main role="main" class="main-content p-0">
        <!-- Enhanced Header Section -->
        <div class="enhanced-header">
            <div class="container">
                <!-- Back Button -->
                <div class="mb-2">
                    <a href="{% url 'user_dashboard:home' %}" class="btn btn-link text-white p-0"
                        style="text-decoration: none; font-size: 0.85rem;">
                        <i class="fe fe-arrow-left"></i> Back to Dashboard
                    </a>
                </div>

                <!-- User Greeting -->
                <div class="user-greeting">
                    <div class="d-flex align-items-center mb-3">        
                        <div>
                            <h1>Welcome back, {{ user_profile.owner.first_name }}!</h1>
                            <p>Track your savings goals and achieve your dreams</p>
                        </div>
                    </div>
                </div>

                <!-- Analytics Overview Cards (HORIZONTAL SCROLL ON MOBILE) -->
                <div class="analytics-overview position-relative">
                    <div class="analytics-scroll-container">
                        <!-- Total Saved -->
                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z" />
                                </svg>
                            </div>
                            <div class="analytics-label">Total Saved</div>
                            <div class="analytics-value">{{ analytics.total_saved|floatformat:2 }}</div>
                        </div>

                        <!-- Interest Earned -->
                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                                </svg>
                            </div>
                            <div class="analytics-label">Interest</div>
                            <div class="analytics-value">{{ analytics.total_interest_earned|floatformat:2 }}</div>
                        </div>

                        <!-- Avg Monthly -->
                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
                                </svg>
                            </div>
                            <div class="analytics-label">Avg/Month</div>
                            <div class="analytics-value">{{ analytics.average_monthly_savings|floatformat:2 }}</div>
                        </div>

                        <!-- Completion Rate -->
                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                                </svg>
                            </div>
                            <div class="analytics-label">Complete</div>
                            <div class="analytics-value">{{ analytics.goal_completion_rate }}%</div>
                        </div>

                        <!-- Savings Streak -->
                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z" />
                                </svg>
                            </div>
                            <div class="analytics-label">Streak</div>
                            <div class="analytics-value">{{ analytics.savings_streak }} mo</div>
                        </div>

                        <!-- Active Goals -->
                        <div class="analytics-card">
                            <div class="analytics-icon">
                                <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                                </svg>
                            </div>
                            <div class="analytics-label">Active</div>
                            <div class="analytics-value">{{ analytics.active_goals }}</div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-container">
                    <div class="stat-card-modern">
                        <div class="stat-icon-wrapper">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                        </div>
                        <div class="stat-value">{{ analytics.active_personal_goals }}</div>
                        <div class="stat-label">Personal</div>
                    </div>

                    <div class="stat-card-modern">
                        <div class="stat-icon-wrapper">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                            </svg>
                        </div>
                        <div class="stat-value">{{ analytics.active_group_goals }}</div>
                        <div class="stat-label">Group</div>
                    </div>

                    <div class="stat-card-modern">
                        <div class="stat-icon-wrapper">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg>
                        </div>
                        <div class="stat-value">{{ analytics.completed_goals }}</div>
                        <div class="stat-label">Achieved</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Goal Section -->
        <section class="create-goals-section">
            <div class="container">
                <div class="section-title">
                    <h2>Create a Goal</h2>
                    <p>Start saving towards your financial dreams</p>
                </div>

                <div class="goal-type-cards">
                    <!-- Express Saving -->
                    <a href="{% url 'goals:express_saving_dashboard' %}" class="goal-type-card">
                        <div class="goal-icon-circle">
                            <img src="{% static 'images/flash.png' %}" alt="Express Saving"
                                style="width: 28px; filter: brightness(0) invert(1);">
                        </div>
                        <h5>Express Saving</h5>
                        <p>Quick savings</p>
                    </a>

                    <!-- Personal Goals -->
                    <a href="{% url 'goals:create_personal_goals' %}" class="goal-type-card">
                        <div class="goal-icon-circle">
                            <img src="{% static 'images/person-plus.png' %}" alt="Personal Goals"
                                style="width: 28px; filter: brightness(0) invert(1);">
                        </div>
                        <h5>Personal Goals</h5>
                        <p>Your dreams</p>
                    </a>

                    <!-- Group Goals -->
                    <a href="{% url 'goals:create_group_goal' %}" class="goal-type-card">
                        <div class="goal-icon-circle">
                            <img src="{% static 'images/people-fill.png' %}" alt="Group Goals"
                                style="width: 28px; filter: brightness(0) invert(1);">
                        </div>
                        <h5>Group Goals</h5>
                        <p>Save together</p>
                    </a>
                </div>

                <!-- Express Saving Wallet -->
                <div class="goals-list-section">
                    <div class="section-header-modern">
                        <h3>Express Saving</h3>
                    </div>

                    <a href="{% url 'goals:express_saving_dashboard' %}" class="wallet-card">
                        <div class="wallet-label">My Express Saving Wallet</div>
                        <h2 class="wallet-amount">Kshs. {{ my_wallet.goal_balance|floatformat:2 }}</h2>
                    </a>
                </div>

                <!-- Active Personal Goals -->
                <div class="goals-list-section">
                    <div class="section-header-modern">
                        <h3>Personal Goals</h3>
                        <span class="active-badge">{{ analytics.active_personal_goals }} Active</span>
                    </div>

                    {% if progressing_goals %}
                    <div class="row g-3">
                        {% for item in progressing_goals %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="{% url 'goals:goal_details' item.id %}" class="goal-card-modern">
                                <div class="goal-header-row">
                                    <h4 class="goal-name">{{ item.name }}</h4>
                                    <span class="goal-type-badge">Personal</span>
                                </div>

                                <div class="donut-container">
                                    <div class="donut-chart" style="--progress: {{ item.percentage }}%;">
                                        <div class="donut-center">
                                            <div class="donut-percentage">{{ item.percentage }}%</div>
                                            <div class="donut-label">Done</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="goal-amount-display">Kshs. {{ item.goal_amount|floatformat:2 }}</div>

                                <div class="goal-meta-info">
                                    <div class="days-remaining">
                                        ðŸ“… {{ item.calculate_month_difference }} days
                                    </div>
                                    <div class="progress-percentage">{{ item.percentage }}%</div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“Š</div>
                        <h4>No Active Personal Goals</h4>
                        <p>Create your first personal goal to start saving towards your dreams!</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Active Group Goals -->
                <div class="goals-list-section">
                    <div class="section-header-modern">
                        <h3>Group Goals</h3>
                        <span class="active-badge">{{ analytics.active_group_goals }} Active</span>
                    </div>

                    {% if group_progressing_goals %}
                    <div class="row g-3">
                        {% for item in group_progressing_goals %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="{% url 'goals:group_goal_details' item.id %}" class="goal-card-modern">
                                <div class="goal-header-row">
                                    <h4 class="goal-name">{{ item.goal_name }}</h4>
                                    <span class="goal-type-badge">Group</span>
                                </div>

                                <div class="donut-container">
                                    <div class="donut-chart" style="--progress: {{ item.percentage }}%;">
                                        <div class="donut-center">
                                            <div class="donut-percentage">{{ item.percentage }}%</div>
                                            <div class="donut-label">Done</div>
                                        </div>
                                    </div>
                                </div>

                                <div class="goal-amount-display">Kshs. {{ item.target_amount|floatformat:2 }}</div>

                                <div class="goal-meta-info">
                                    <div class="days-remaining">
                                        ðŸ“… {{ item.calculate_month_difference }} days
                                    </div>
                                    <div class="progress-percentage">{{ item.percentage }}%</div>
                                </div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ‘¥</div>
                        <h4>No Active Group Goals</h4>
                        <p>Create a group goal and invite others to save together!</p>
                    </div>
                    {% endif %}
                </div>

                <!-- âœ¨ COMPLETED GOALS WITH CHECKMARK âœ¨ -->
                {% if complete_goals or group_complete_goals %}
                <div class="goals-list-section completed-goals-section">
                    <div class="section-header-modern">
                        <h3>Completed Goals</h3>
                        <span class="active-badge completed">{{ analytics.completed_goals }} Completed</span>
                    </div>

                    <div class="row g-3">
                        {% for item in complete_goals %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="{% url 'goals:goal_details' item.id %}" class="completed-goal-card">
                                <div class="completed-goal-header">
                                    <div class="completed-goal-name">{{ item.name }}</div>
                                    <div class="completed-checkmark">âœ“</div>
                                </div>
                                <div class="completed-goal-amount">Kshs. {{ item.goal_amount|floatformat:2 }}</div>
                            </a>
                        </div>
                        {% endfor %}

                        {% for item in group_complete_goals %}
                        <div class="col-12 col-md-6 col-lg-4">
                            <a href="{% url 'goals:group_goal_details' item.id %}" class="completed-goal-card">
                                <div class="completed-goal-header">
                                    <div class="completed-goal-name">{{ item.goal_name }}</div>
                                    <div class="completed-checkmark">âœ“</div>
                                </div>
                                <div class="completed-goal-amount">Kshs. {{ item.target_amount|floatformat:2 }}</div>
                            </a>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </section>
    </main>



</div>

<!-- Donut animation -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const donuts = document.querySelectorAll('.donut-chart');
        donuts.forEach(donut => {
            const progress = parseFloat(donut.style.getPropertyValue('--progress')) || 0;
            donut.style.setProperty('--progress', '0%');
            setTimeout(() => {
                donut.style.setProperty('--progress', progress + '%');
            }, 100);
        });
    });
</script>

<!-- jQuery AJAX handlers -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        // Personal Goals Creation Handler
        $('#personal_goals_created').on('submit', function (e) {
            e.preventDefault();
            var savingInputType = $('input[name="saving_input_type"]:checked').val();
            $.ajax({
                type: "POST",
                url: "{% url 'goals:create_personal_goals' %}",
                data: {
                    saving_input_type: savingInputType,
                    goal_title: $('#goal_title').val(),
                    target_amount: $('#target-amount').val(),
                    amount_to_save: $('#calculated-amount').val(),
                    start_date: $('#start_date').val(),
                    end_date: $('#end_date').val(),
                    just_want_to_save: $('#just_want_to_save').is(':checked') ? 'on' : 'off',
                    reminder_frequency: $('#reminder_frequency').val(),
                    select_payment_frequency: $('#select_payment_frequency').val(),
                    is_saving_or_goal: $('#is_saving_or_goal').is(':checked') ? 'on' : 'off',
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function (response) {
                    if (response.success === '1') {
                        window.location.href = "{% url 'goals:goal_details' 0 %}".replace('0', response.goal_id);
                    } else {
                        window.location.reload();
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error creating goal:", error);
                    alert("An error occurred while creating the goal. Please try again.");
                }
            });
        });

        // Group Goal Creation Handler
        $('#group_goal_id').on('submit', function (e) {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: "{% url 'goals:create_group_goal' %}",
                data: {
                    goal_name: $('#goal_name').val(),
                    goal_mission: $('#goal_mission').val(),
                    start_date: $('#start_date_group').val(),
                    end_date: $('#end_date_group').val(),
                    target_amount: $('#target_amount').val(),
                    saving_type_input: $('#saving_type_input').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function (response) {
                    if (response.success === '1') {
                        window.location.href = "{% url 'goals:group_goal_details' 0 %}".replace('0', response.goal_id);
                    } else {
                        window.location.reload();
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error creating group goal:", error);
                    alert("An error occurred while creating the group goal. Please try again.");
                }
            });
        });
    });
</script>
{% endblock %}